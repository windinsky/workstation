/*! my-project-name 2016-03-11 */
windinsky.define("template/index",["jquery","images/upload"],function(a,b,c){function d(a){H=a,C=null,$(".area,.line").removeClass("active"),H.addClass("active")}function e(a){C=a,H=null,$(".area,.line").removeClass("active"),C.addClass("active")}function f(a){$(".line").removeClass("active"),C=$('<div class="line active '+a+'">').appendTo(y),"v"===a&&C.css({height:y.height()+"px",top:0,left:$(document).scrollLeft()-y.offset().left+document.documentElement.clientWidth/2+"px"}),"h"===a&&C.css({width:"100%",top:$(document).scrollTop()-y.offset().top+document.documentElement.clientHeight/3+"px",left:0})}function g(a){a.preventDefault()}function h(a){var b=$(a.target);d(b.parents(".area:first")),B={x:a.clientX+$(document).scrollLeft(),y:a.clientY+$(document).scrollTop()},D={x:parseInt(H.css("left")),y:parseInt(H.css("top"))},F={w:H.width(),h:H.height()};var c="";return b.hasClass("content")?(m(),!1):(b.hasClass("l_handle")?c="l":b.hasClass("r_handle")?c="r":b.hasClass("t_handle")?c="t":b.hasClass("b_handle")?c="b":b.hasClass("lt_handle")?c="lt":b.hasClass("rb_handle")?c="rb":b.hasClass("lb_handle")?c="lb":b.hasClass("rt_handle")&&(c="rt"),E=c,p(),!1)}function i(){"编辑热区"==$("#lock_line").val()?($(".line").addClass("lock"),$(".area").removeClass("lock"),$("#lock_line").val("编辑参考线"),y.delegate(".handle,.content","mousedown",h),y.on("mousedown",s),y.undelegate(".line","mousedown",j)):($(".line").removeClass("lock"),$(".area").addClass("lock"),$("#lock_line").val("编辑热区"),y.unbind("mousedown",s),y.undelegate(".handle,.content","mousedown",h),y.delegate(".line","mousedown",j))}function j(a){return e($(a.target)),B={x:a.clientX+$(document).scrollLeft(),y:a.clientY+$(document).scrollTop()},D={x:parseInt(C.css("left"))||0,y:parseInt(C.css("top"))||0},y.undelegate(".line","mousedown",j),$(document).bind("mousemove",k),$(document).bind("mouseup",l),!1}function k(a){if(C.hasClass("h")){mouse_y=a.clientY+$(document).scrollTop();var b=D.y+mouse_y-B.y;b=Math.max(0,b),b=Math.min(y.height(),b),C.css({top:b+"px"})}if(C.hasClass("v")){mouse_x=a.clientX+$(document).scrollLeft();var c=D.x+mouse_x-B.x;c=Math.max(0,c),c=Math.min(c,y.width()),C.css({left:c+"px"})}}function l(){y.delegate(".line","mousedown",j),$(document).unbind("mousemove",k),$(document).unbind("mouseup",l)}function m(a){return y.undelegate(".handle,.content","mousedown",h),$(document).bind("mousemove",n),$(document).bind("mouseup",o),!1}function n(a){var b=a.clientX+$(document).scrollLeft(),c=a.clientY+$(document).scrollTop(),d=c-B.y+D.y;d=Math.max(0,d),d=Math.min(y.height()-H.height(),d);var e=b-B.x+D.x;e=Math.max(0,e),e=Math.min(y.width()-H.width(),e),H.css({top:d+"px",left:e+"px"})}function o(){y.delegate(".handle,.content","mousedown",h),$(document).unbind("mousemove",n),$(document).unbind("mouseup",o)}function p(){y.undelegate(".handle,.content","mousedown",h),$(document).bind("mousemove",r),$(document).bind("mouseup",q)}function q(){y.delegate(".handle,.content","mousedown",h),$(document).unbind("mousemove",r),$(document).unbind("mouseup",q)}function r(a){var b=H.find(".content");if(-1!==E.indexOf("l")){var c=a.clientX+$(document).scrollLeft()-B.x,d=F.w-c;d=Math.max(3,d),d=Math.min(D.x+F.w,d);var e=c+D.x;e=Math.max(0,e),e=Math.min(e,D.x+F.w-3,e),b.css({width:d-2+"px"}),H.css({left:e+"px"})}if(-1!==E.indexOf("r")){var c=a.clientX+$(document).scrollLeft()-B.x,d=F.w+c;d=Math.max(3,d),d=Math.min(y.width()-D.x-2,d),b.css({width:d+"px"})}if(-1!==E.indexOf("t")){var f=a.clientY+$(document).scrollTop()-B.y,g=F.h-f;g=Math.max(3,g),g=Math.min(D.y+F.h-2,g);var h=f+D.y;h=Math.max(0,h),h=Math.min(D.y+F.h-3,h),b.css({height:g-2+"px"}),H.css({top:h+"px"})}if(-1!==E.indexOf("b")){var f=a.clientY+$(document).scrollTop()-B.y,g=F.h+f;g=Math.max(3,g),g=Math.min(y.height()-D.y,g),b.css({height:g+"px"})}}function s(a){y.unbind("mousedown",s),B={x:a.clientX+$(document).scrollLeft(),y:a.clientY+$(document).scrollTop()},D={x:B.x-G.left,y:B.y-G.top},$(document).bind("mousemove",t),$(document).bind("mouseup",u),d($(A).appendTo(y).css({left:D.x+"px",top:D.y+"px"}))}function t(a){var b=a.clientX+$(document).scrollLeft(),c=a.clientY+$(document).scrollTop();b=Math.max(b,G.left),b=Math.min(b,G.left+y.width()-2),c=Math.max(c,G.top),c=Math.min(c,G.top+y.height()-2);var d={x:b-B.x,y:c-B.y};H.find(".content").css({width:Math.abs(d.x)+"px",height:Math.abs(d.y)+"px"}),d.x<0&&H.css({left:D.x+d.x+"px"}),d.y<0&&H.css({top:D.y+d.y+"px"})}function u(a){y.bind("mousedown",s),$(document).unbind("mousemove",t),$(document).unbind("mouseup",u),H.find("div").show()}function v(){var a=$("#platform").val(),b=$(".area").map(function(a,b){return{x:parseInt($(b).css("left")),y:parseInt($(b).css("top")),w:$(b).width(),h:$(b).height()}}).toArray();$.ajax({url:"/template/save",data:{canvas_size:JSON.stringify({w:y.width(),h:y.height()}),cords:JSON.stringify(b),image_id:w,platform:a},dataType:"text",type:"post",success:function(a){window.open(a)}})}var w,x=a("images/upload"),y=$("#canvas"),z=[],A='<div class="area"><div class="lt_handle handle"></div><div class="rt_handle handle"></div><div class="lb_handle handle"></div><div class="rb_handle handle"></div><div class="l_handle handle"></div><div class="r_handle handle"></div><div class="t_handle handle"></div><div class="b_handle handle"></div><div class="content"></div></div>';$("#clear_line").click(function(){$(".line").remove(),z=z.filter(function(a){return!$(a).hasClass("line")})}),$(document).on("keydown",function(a){if(H||C){if(68==a.keyCode)return(C||H).hide(),z.push(C||H),a.preventDefault(),!1;if(90==a.keyCode&&(a.ctrlKey||a.metaKey)){var b=z.pop();b&&d(b.show())}}}),$("#add_v_line").click(function(){f("v")}),$("#add_h_line").click(function(){f("h")}),x.setup_upload($("#file"),$("#progress").find(".close"),function(a){y.css("width",a.width+"px"),G=$("#canvas").offset(),w=a.id,$("#progress").find(".close").trigger("click"),y.find("img").attr("src",a.src).show(),$("#file").unbind("change"),$("#save").click(v)});var B,C,D,E,F,G;y.find("img").mousedown(g).mouseup(g).click(g).mousemove(g),$("#lock_line").click(i),y.delegate(".line","mousedown",j);var H});