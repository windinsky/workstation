/*! my-project-name 2016-03-11 */
windinsky.define("charts/pie",["jquery","d3"],function(a,b,c){function d(a,b){this.data=[],this.__prop__=f.extend(this.default_prop,b),this.con=e.select(a);this.svg=this.con.append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("class","__chart_"+this.name);this.reset_size()}var e=a("d3"),f=a("jquery"),g=e.scale.category20c().domain(e.range(20));d.prototype.reset_size=function(){var a=this.con.node().getBoundingClientRect();this.width=a.width,this.height=a.height,this.svg.attr("width",this.width).attr("height",this.height)},d.prototype.default_prop={skin:"dark",axis:!0,ticks:!0,max:void 0,min:void 0,padding:40},Object.defineProperty(d.prototype.name,"name",{writable:!1,value:"pie"}),Object.defineProperty(d.prototype,"data",{set:function(a){this.__data__=a},get:function(){return this.__data__}}),d.prototype.data=function(a){return a?void(this.__data__=a):this.__data__},d.prototype.remove_data_set=function(a){return this.data.splice(a,1),this},d.prototype.render=function(){return this.el?this.refresh():this._render(),this},d.prototype.format_error="data format error, only accept [ [k1,num1],[k2,num2] ... ] or [ v1 , v2 , v3 ]",d.prototype.add_data_set=function(a){var b=this;if(!a||!a instanceof Array)throw this.format_error;return a.forEach(function(c,d){if(null===c||void 0===c)throw b.format_error;if(c instanceof Array){if(!c[1]||!c[1].toFixed)throw b.format_error}else{if(!c.toFixed)return this.format_error;a[d]=[(d+1).toString(),c]}}),this.data.push(a),this},d.prototype.add_data=function(a){return this.append_datas([a])},d.prototype.append_datas=function(a){console.assert(a&&a instanceof Array&&a.length===this.data.length,"data 数目和当前数据不一致");var b=this;return a.forEach(function(c,d){console.assert(void 0!==c&&null!==c,this.format_error),c instanceof Array&&console.assert(void 0!==c[1]&&null!==c[1]&&c[1].toFixed,this.format_error),c.toFixed&&(a[d]=[b.data[0].length.toString(),c]),b.data[d].push(a[d])}),this},d.prototype._render=function(){return this.refresh()},d.prototype.refresh=function(){this.reset_size();var a=this,b=this.__prop__.padding;if(!this.data.length)return this.svg.selectAll("g.pies").classed("hide",!0),alert("no data left to display");var c=this.data[0].length;console.assert(this.data.every(function(a){return a.length===c}));for(var d=[],f=0;f<this.data[0].length;f++)for(var h=0;h<this.data.length;h++)d.push(this.data[h][f]);var i=a.data[0].map(function(a){return a[0]}),j=[0,e.max(d.map(function(a){return a[1]}))],k=[b,this.width-2*b],l=[this.height-2*b,b];if(this.xScale.domain(i).rangeBands(k,.3,.3),this.yScale.domain(j).range(l),this.svg.select(".x.axis").transition().duration(0).call(this.xAxis.outerTickSize(3).innerTickSize(-this.height+3*b).tickPadding(10)).attr("transform","translate( 0 ,"+(this.height-2*b)+")"),this.svg.select(".y.axis").transition().duration(0).call(this.yAxis.outerTickSize(3).innerTickSize(-this.width+3*b)).attr("transform","translate("+b+", 0 )"),1===this.data.length){var m=this.svg.select("g.lines");m.empty()&&(m=this.svg.append("g").attr("class","lines"),m.append("path").attr("class","line")),m.classed("hide",!1);var n=e.svg.line().x(function(b,c){var d=a.data[0].map(function(a){return a[0]})[parseInt(c/a.data.length)];return a.xScale(d)+a.xScale.rangeBand()/2}).y(function(b){return a.yScale(b[1])}).interpolate("monotone");this.svg.selectAll("path.line").transition().duration(0).attr("d",n(this.data[0])).attr("class","line");var o=this.svg.selectAll("g.points");o.empty()&&(o=this.svg.append("g").attr("class","points")),o.classed("hide",!1);var p=o.selectAll("circle.point").data(this.data[0]);p.enter().append("circle"),p.transition().attr("cx",function(b,c){return a.xScale(b[0])+a.xScale.rangeBand()/2}).attr("cy",function(b){return a.yScale(b[1])}).style("transform-origin",function(b,c){return a.xScale(c)+a.xScale.rangeBand()/2+"px "+a.yScale(b[1])+"px"}),p.exit().transition().attr("x",this.width).remove()}else this.svg.selectAll("g.lines , g.points ").classed("hide",!0).transition().duration(500);var q=this.svg.selectAll("g.labels");q.empty()&&(q=this.svg.append("g").attr("class","labels")),q.classed("hide",!1);var r=q.selectAll("text.label").data(d);r.enter().append("text").attr("class","label"),r.transition().duration(0).attr("x",function(b,c){var d=a.data[0].map(function(a){return a[0]})[parseInt(c/a.data.length)];return a.xScale(d)+c%a.data.length*a.xScale.rangeBand()/a.data.length+a.xScale.rangeBand()/2/a.data.length}).attr("y",function(b){return a.yScale(b[1])-10}).text(function(a){return a[1]}).style("text-anchor","middle"),r.exit().transition().duration(0).attr("x",a.width).remove();var s=this.svg.select("g.pies");s.empty()&&(s=this.svg.append("g").attr("class","pies")),s.classed("hide",!1);var t=s.selectAll("rect.pie").data(d);return t.enter().append("rect"),t.transition().duration(500).attr("class","pie").attr("x",function(b,c){var d=a.data[0].map(function(a){return a[0]})[parseInt(c/a.data.length)];return a.xScale(d)+c%a.data.length*a.xScale.rangeBand()/a.data.length}).attr("y",function(b){return a.yScale(b[1])}).attr("fill",function(b,c){return g(c%a.data.length%20)}).attr("width",function(){return a.xScale.rangeBand()/a.data.length}).attr("height",function(c,d){return a.height-2*b-a.yScale(c[1])}),t.exit().transition().attr("x",this.width).remove(),this},d.prototype.prop=function(a){return a?void f.extend(this.__prop__,a):this.__prop__},c.exports=d});