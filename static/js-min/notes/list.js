/*! my-project-name 2016-03-11 */
windinsky.define("notes/list",["jquery","lib/clearHtmlTag","localstorage","ui/confirm"],function(a,b,c){function d(a,b){a instanceof Object&&(b=a,a=b.id);var c=notes.every(function(c,d){return c.id==a||c.fake_id==b.fake_id?(notes.splice(d,1),notes.push(b),!1):!0});c&&notes.push(b)}function e(a){h("#id").val(a.id),h("#title").val(a.title),ignore=!0,ckeditor.setData(a.content)}function f(){AutoSave.stop(l),AutoSave.updateCfg({namespace:l,url:"/notes/save"}),AutoSave.EventEmitter.on("notes_save_ok",function(a){var b=a[0],c=a[1],e=b.fake_id,f=h("#note_"+e);b.id||(f.attr("data-id",c.id),f.hasClass("selected")&&h("#id").val(c.data.id),b.id=c.data.id,d(b)),notes.every(function(a,d){return a.id==b.id||a.fake_id==b.fake_id?(notes[d].updated_at=c.data.updated_at,notes[d].id=c.data.id,!1):!0})});var a=AutoSave.getRecords(l);a.length&&a.forEach(function(a){notes.forEach(function(b,c){b.id==a.id&&b.updated_at==a.updated_at&&(d(a),h("#id").val()==b.id&&(ckeditor.setData(a.content),h("#title").val(a.title)),h('[data-id="'+a.id+'"] span:first').html(j.process(a.title)))})}),AutoSave.EventEmitter.on("notes_save_err",function(a){var b=a[0],c=a[1];c.error.code==windinsky.cfg.error_code.DATABASE.CONFLICT&&(AutoSave.removeRecord(l,function(a){return a.id==b.id}),new i("Auto save failed, your note has been modified on other client,you can save your version as a new note or load the new version(you would lose all your changes)",{yesBtn:"save mine as a new one",noBtn:"load latest version",callback:{yes:function(){h.ajax({data:{title:b.title,content:b.content},url:"/notes/save",type:"post",success:function(){location.href=location.href},error:function(a){alert("save error"+a)}})},no:function(){var a=c.error.latest_record;h("#id").val()==b.id&&e(a),d(a),h("#note_"+b.fake_id).find("span:first").html(j.process(a.title))}}}))}),AutoSave.start(l)}function g(){if(ignore)return ignore=!ignore;var a,b=h("#id").val();if(b?notes.forEach(function(c,d){return b==c.id?(a=notes[d]={updated_at:notes[d].updated_at,fake_id:h(".notes_list li.selected").attr("id").split("_")[1],content:ckeditor.getData(),title:h("#title").val(),id:b},!1):!0}):a={title:h("#title").val(),fake_id:h(".notes_list li.selected").attr("id").split("_")[1],content:ckeditor.getData()},a.title&&a.title!=k||a.content){a.id&&(a.updated_at=notes.filter(function(a){return a.id==b})[0].updated_at),d(a);var c=AutoSave.getRecords(l),e=!1;c.every(function(b,d){return b.fake_id===a.fake_id?(c[d]=a,AutoSave.updateRecords(l,c),e=!0,!1):!0}),e||AutoSave.addRecord(l,a)}}var h=a("jquery"),i=a("ui/confirm"),j=a("lib/clearHtmlTag"),k="New note",l="notes";global.AutoSave?f():__localstorage_loaded.once("end",f),h(".notes_list").delegate("li","click",function(a){ignore=!0,h("#title").removeAttr("readonly");var b=h(this),c=b.attr("data-id"),d=b.attr("id").split("_")[1],f=notes.filter(function(a){return a.id==c||a.fake_id==d})[0];h(".notes_list li").removeClass("selected"),b.addClass("selected"),ckeditor.setReadOnly(!1),e(f)}).delegate("span.trash","click",function(a){function b(){c.remove(),notes.every(function(a,b){return a.id==d||a.fake_id==e?(notes.splice(b,1),!1):!0})}var c=h(this).parent(),d=c.attr("data-id"),e=c.attr("id").split("_")[1];return d?(h.ajax({url:"/notes/delete",type:"delete",data:{id:d},dataType:"json",success:function(a){b(),a.success&&AutoSave.removeRecord(l,function(a){return a.id==d})}}),!1):b()}),h("#add_new").on("click",function(){var a=(new Date).getTime(),b=h('<li id="note_'+a+'"><span>'+k+'</span><span class="trash"></span></li>').prependTo(h(".notes_list ul"));notes.push({fake_id:a,title:k,content:""}),b.trigger("click")}),h(".notes_list li").length>0&&(h("#title").removeAttr("readonly"),h(".notes_list li:first").trigger("click")),h("#title").on("keyup",function(){g(),h(".selected > span:first").html(j.process(this.value))}),ckeditor.on("change",g)});