/*! my-project-name 2016-03-11 */
windinsky.define("localstorage",["utils","jquery"],function(a,b,c){var d=a("jquery"),e=a("utils"),f=":",g=localStorage,h=b.set=function(a,b,c){if(!a||void 0===b)return!1;var d=a.split(f);if(1===d.length)return g[d[0]]=JSON.stringify(b),!0;var e;try{c&&(g[d[0]]=void 0===g[d[0]]?"{}":g[d[0]]),e=JSON.parse(g[d[0]])}catch(h){return console.log("aaaa",h),!1}var i=d.splice(0,1)[0];try{var j=e;return d.forEach(function(a,e){e!==d.length-1?(c&&void 0===j[a]&&(j[a]={}),j=j[a]):j[a]=b}),g[i]=JSON.stringify(e),!0}catch(h){return console.log("bbbb",h),!1}},i=b.get=function(a){if(a){var b=a.split(f);if(1===b.length)return void 0===g[b[0]]?void 0:JSON.parse(g[b[0]]);var c=JSON.parse(g[b[0]]);b.splice(0,1);try{return b.forEach(function(a){c=c[a]}),c}catch(d){return}}},j=(b.append=function(a,b){!b instanceof Array&&(b=[b]);var c=i(a);return!c instanceof Array?!1:h(a,c.concat(b))},b.config=function(a){var b=a.namespace;delete a.namespace,h(["config",b].join(f),a,!0)}),k=b.remove=function(a){var b=a.split(f);if(1==b.length)return g.removeItem(a),!0;var c=JSON.parse(g[b[0]]),d=c,e=b.splice(0,1)[0];try{return b.forEach(function(a,c){c===b.length-1?delete d[a]:d=d[a]}),g[e]=JSON.stringify(c),!0}catch(h){return!1}},l={init:function(){global.__page_id=(new Date).getTime().toString()+parseInt(9*Math.random()),!i("autosave")&&h("autosave",{}),!i("autosave:storage")&&h("autosave:storage",{})},updateCfg:function(a){var b=a.namespace,c=i("config:"+b);if(b){if(c){var d=c.__started;if(delete c.__started,c.namespace=b,e.object.equals(c,a))return;a.__started=d}j(a),l.reloadCfg()}},start:function(a){if(l.config||l.reloadCfg(),a){if(!l.config[a])throw"AutoSave ERROR: "+a+" has not been configured. you can not start it.";if(l.config[a].__started)return;l.config[a].__started=!0,h("config:"+a,l.config[a]),l.timers[a]=setInterval(function(){l.save(a)},l.config[a].timer||1e4)}else for(var b in l.config)l.config.hasOwnProperty(b)&&l.start(b)},stop:function(a){clearInterval(l.timers[a]);var b=l.config[a];b&&(delete b.__started,b.namespace=a,j(b))},reloadCfg:function(){l.config=i("config")},timers:{},config:null,addRecord:function(a,b){var c=["autosave","storage",a].join(f),d=i(c);d&&d.length?h(c,d.concat([b])):h(c,[b])},getRecords:function(a){return i(["autosave","storage",a].join(f))||[]},clearRecords:function(a){return k(["autosave","storage",a].join(f))},updateRecords:function(a,b){return h(["autosave","storage",a].join(f),b,!0)},removeRecord:function(a,b){if(a){var c=["autosave","storage",a].join(f),d=i(c),e=[];d&&d.forEach(function(a){b(a)===!1&&e.push(a)}),h(c,e)}},saveAllImmediately:function(a,b){var c=new EventEmitter;if(a){var e=["autosave","storage",a].join(f),g=l.config[a],j=0,k=i(e),m=!1;return k.forEach(function(a,b){a.__isSaving||(j++,a.__isSaving=!0,l.__save(g,a,function(a,b){return!a&&b&&b.success?c.emit("success",this):void c.emit("error",{error:a||b.msg,index:this})}.bind(b)))}),c.once("error",function(){m=!0,c.emit("failed")}).on("error",function(b){j--,0===j&&c.emit("end");var d=k[b.index];l.EventEmitter.emit(a+"_save_err",[d,b]),delete k[b.index].__isSaving}).on("success",function(b){j--;var e=k[b];delete e.__isSaving,l.EventEmitter.emit(a+"_save_ok",d.extend(e,b)),k[b]=void 0,0===j&&c.emit("end")}).once("end",function(){var a=k.forEach(function(b){void 0!==b&&a.push(b)});h(e,a),m||c.emit("succeeded")})}throw"namespace must be specific"},save:function(a){var b=l.config[a],c=["autosave","storage",a].join(f),d=i(c);d&&d.length&&(l.__save(b,d[0],function(b,e){if(!b&&e&&1===e.success){var f=d.splice(0,1)[0];delete f.__isSaving,h(c,d),l.EventEmitter.emit(a+"_save_ok",[f,e])}else delete d[0].__isSaving,h(c,d),l.EventEmitter.emit(a+"_save_err",[d[0],e])}),d[0].__isSaving=!0,h(c,d))},__save:function(a,b,c){d.ajax({url:a.url,data:b,type:"post",dataType:"json",success:function(a){c(void 0,a)},error:function(a){c(a)}})},EventEmitter:new EventEmitter};g.config=g.config||"{}",b.AutoSave=l});